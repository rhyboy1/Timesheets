<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protech Timesheet</title>
    <!-- Font and Tailwind CSS via CDN -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <!-- Firebase SDKs -->
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        input, select, button, canvas {
            border-radius: 0.75rem; /* rounded-xl */
        }
        .signature-canvas {
            border: 2px dashed #d1d5db; /* border-gray-400 */
            background-color: #f9fafb; /* bg-gray-50 */
            touch-action: none;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 flex justify-center font-sans text-gray-800">

    <!-- Main App Container -->
    <div id="app-container" class="bg-white p-6 md:p-10 rounded-3xl shadow-2xl w-full max-w-4xl space-y-8">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6">
            <h1 class="text-3xl md:text-4xl font-extrabold text-blue-800 tracking-tight">Protech Timesheet</h1>
            <p class="text-sm text-gray-500 mt-2 md:mt-0">User ID: <span id="userIdDisplay" class="font-mono text-gray-700"></span></p>
        </div>

        <!-- Non-blocking message box for feedback and errors -->
        <div id="message-box" class="hidden bg-blue-100 text-blue-800 p-4 rounded-xl text-sm font-medium border border-blue-200"></div>
        
        <!-- Main Application Content -->
        <div id="app-content">
            <div class="flex flex-col md:flex-row gap-4 mb-6">
                <button id="toggleTimesheetButton" class="px-6 py-3 bg-gray-200 text-gray-800 font-bold rounded-full shadow-md hover:bg-gray-300 focus:outline-none focus:ring-4 focus:ring-gray-400 transition-all transform hover:scale-105">
                    Back to my Timesheet
                </button>
                <button id="shareTimesheetButton" class="px-6 py-3 bg-green-500 text-white font-bold rounded-full shadow-lg hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-300 transition-all transform hover:scale-105">
                    Share This Timesheet
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-gray-50 p-6 rounded-2xl shadow-inner">
                <div class="flex flex-col">
                    <label class="text-sm font-semibold text-gray-600 mb-1">Company Name:</label>
                    <input type="text" id="companyName" class="p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all" />
                </div>
                <div class="flex flex-col">
                    <label class="text-sm font-semibold text-gray-600 mb-1">Employee Name:</label>
                    <input type="text" id="employeeName" class="p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all" />
                </div>
                <div class="flex flex-col">
                    <label class="text-sm font-semibold text-gray-600 mb-1">Supervisor Name:</label>
                    <input type="text" id="supervisorName" class="p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all" />
                </div>
                <div class="flex flex-col">
                    <label class="text-sm font-semibold text-gray-600 mb-1">Site Name:</label>
                    <input type="text" id="siteName" class="p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all" />
                </div>
                <div class="flex flex-col">
                    <label class="text-sm font-semibold text-gray-600 mb-1">Employee Position:</label>
                    <input type="text" id="employeePosition" class="p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all" />
                </div>
                <div class="flex flex-col">
                    <label class="text-sm font-semibold text-gray-600 mb-1">Supervisor Position:</label>
                    <input type="text" id="supervisorPosition" class="p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all" />
                </div>
                <div class="flex flex-col">
                    <label class="text-sm font-semibold text-gray-600 mb-1">Week End Date:</label>
                    <input type="date" id="weekEndDate" class="p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all" />
                </div>
                <div class="flex flex-col">
                    <label class="text-sm font-semibold text-gray-600 mb-1">Emp ID (from Payslip):</label>
                    <input type="text" id="employeeId" class="p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all" />
                </div>
                <div class="flex flex-col">
                    <label class="text-sm font-semibold text-gray-600 mb-1">State:</label>
                    <input type="text" id="state" class="p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all" />
                </div>
            </div>

            <h2 class="text-2xl font-bold text-gray-700 mt-8 mb-4">Daily Entries</h2>

            <div id="dailyEntriesContainer" class="space-y-4">
                <!-- STATIC HTML for all daily entries to ensure they render correctly -->

                <!-- MONDAY -->
                <div class="bg-white p-4 rounded-xl shadow-md border-t-4 border-blue-500 transition-all hover:shadow-xl">
                    <h3 class="text-xl font-bold text-gray-700 mb-2">Monday</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Date:</label>
                            <input type="date" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="0" data-field="date" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Shift (D/A/N):</label>
                            <select class="p-2 border border-gray-300 rounded-lg text-sm" data-index="0" data-field="shift">
                                <option value="">Select</option>
                                <option value="D">D</option>
                                <option value="A">A</option>
                                <option value="N">N</option>
                            </select>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Start Time (24h):</label>
                            <input type="time" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="0" data-field="start" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">End Time (24h):</label>
                            <input type="time" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="0" data-field="end" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Meal Break:</label>
                            <input type="time" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="0" data-field="meal" value="00:30" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Total Hours:</label>
                            <input type="text" class="p-2 border border-gray-300 bg-gray-100 rounded-lg text-sm" data-index="0" data-field="total" readonly />
                        </div>
                        <div class="flex flex-col col-span-1 md:col-span-2 lg:col-span-1">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Extra Information:</label>
                            <input type="text" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="0" data-field="extraInfo" />
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out rounded-sm" data-index="0" data-field="laha" />
                            <label class="text-xs font-semibold text-gray-500">LAHA</label>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out rounded-sm" data-index="0" data-field="lahaMeal" />
                            <label class="text-xs font-semibold text-gray-500">LAHA MEAL</label>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out rounded-sm" data-index="0" data-field="travel" />
                            <label class="text-xs font-semibold text-gray-500">TRAVEL AWAY</label>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Docket Number:</label>
                            <input type="text" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="0" data-field="docket" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Supervisor Daily Initials:</label>
                            <input type="text" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="0" data-field="supervisorInitials" />
                        </div>
                    </div>
                </div>

                <!-- TUESDAY -->
                <div class="bg-white p-4 rounded-xl shadow-md border-t-4 border-blue-500 transition-all hover:shadow-xl">
                    <h3 class="text-xl font-bold text-gray-700 mb-2">Tuesday</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Date:</label>
                            <input type="date" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="1" data-field="date" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Shift (D/A/N):</label>
                            <select class="p-2 border border-gray-300 rounded-lg text-sm" data-index="1" data-field="shift">
                                <option value="">Select</option>
                                <option value="D">D</option>
                                <option value="A">A</option>
                                <option value="N">N</option>
                            </select>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Start Time (24h):</label>
                            <input type="time" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="1" data-field="start" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">End Time (24h):</label>
                            <input type="time" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="1" data-field="end" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Meal Break:</label>
                            <input type="time" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="1" data-field="meal" value="00:30" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Total Hours:</label>
                            <input type="text" class="p-2 border border-gray-300 bg-gray-100 rounded-lg text-sm" data-index="1" data-field="total" readonly />
                        </div>
                        <div class="flex flex-col col-span-1 md:col-span-2 lg:col-span-1">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Extra Information:</label>
                            <input type="text" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="1" data-field="extraInfo" />
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out rounded-sm" data-index="1" data-field="laha" />
                            <label class="text-xs font-semibold text-gray-500">LAHA</label>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out rounded-sm" data-index="1" data-field="lahaMeal" />
                            <label class="text-xs font-semibold text-gray-500">LAHA MEAL</label>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out rounded-sm" data-index="1" data-field="travel" />
                            <label class="text-xs font-semibold text-gray-500">TRAVEL AWAY</label>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Docket Number:</label>
                            <input type="text" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="1" data-field="docket" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Supervisor Daily Initials:</label>
                            <input type="text" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="1" data-field="supervisorInitials" />
                        </div>
                    </div>
                </div>

                <!-- WEDNESDAY -->
                <div class="bg-white p-4 rounded-xl shadow-md border-t-4 border-blue-500 transition-all hover:shadow-xl">
                    <h3 class="text-xl font-bold text-gray-700 mb-2">Wednesday</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Date:</label>
                            <input type="date" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="2" data-field="date" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Shift (D/A/N):</label>
                            <select class="p-2 border border-gray-300 rounded-lg text-sm" data-index="2" data-field="shift">
                                <option value="">Select</option>
                                <option value="D">D</option>
                                <option value="A">A</option>
                                <option value="N">N</option>
                            </select>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Start Time (24h):</label>
                            <input type="time" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="2" data-field="start" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">End Time (24h):</label>
                            <input type="time" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="2" data-field="end" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Meal Break:</label>
                            <input type="time" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="2" data-field="meal" value="00:30" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Total Hours:</label>
                            <input type="text" class="p-2 border border-gray-300 bg-gray-100 rounded-lg text-sm" data-index="2" data-field="total" readonly />
                        </div>
                        <div class="flex flex-col col-span-1 md:col-span-2 lg:col-span-1">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Extra Information:</label>
                            <input type="text" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="2" data-field="extraInfo" />
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out rounded-sm" data-index="2" data-field="laha" />
                            <label class="text-xs font-semibold text-gray-500">LAHA</label>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out rounded-sm" data-index="2" data-field="lahaMeal" />
                            <label class="text-xs font-semibold text-gray-500">LAHA MEAL</label>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out rounded-sm" data-index="2" data-field="travel" />
                            <label class="text-xs font-semibold text-gray-500">TRAVEL AWAY</label>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Docket Number:</label>
                            <input type="text" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="2" data-field="docket" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Supervisor Daily Initials:</label>
                            <input type="text" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="2" data-field="supervisorInitials" />
                        </div>
                    </div>
                </div>

                <!-- THURSDAY -->
                <div class="bg-white p-4 rounded-xl shadow-md border-t-4 border-blue-500 transition-all hover:shadow-xl">
                    <h3 class="text-xl font-bold text-gray-700 mb-2">Thursday</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Date:</label>
                            <input type="date" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="3" data-field="date" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Shift (D/A/N):</label>
                            <select class="p-2 border border-gray-300 rounded-lg text-sm" data-index="3" data-field="shift">
                                <option value="">Select</option>
                                <option value="D">D</option>
                                <option value="A">A</option>
                                <option value="N">N</option>
                            </select>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Start Time (24h):</label>
                            <input type="time" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="3" data-field="start" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">End Time (24h):</label>
                            <input type="time" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="3" data-field="end" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Meal Break:</label>
                            <input type="time" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="3" data-field="meal" value="00:30" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Total Hours:</label>
                            <input type="text" class="p-2 border border-gray-300 bg-gray-100 rounded-lg text-sm" data-index="3" data-field="total" readonly />
                        </div>
                        <div class="flex flex-col col-span-1 md:col-span-2 lg:col-span-1">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Extra Information:</label>
                            <input type="text" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="3" data-field="extraInfo" />
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out rounded-sm" data-index="3" data-field="laha" />
                            <label class="text-xs font-semibold text-gray-500">LAHA</label>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out rounded-sm" data-index="3" data-field="lahaMeal" />
                            <label class="text-xs font-semibold text-gray-500">LAHA MEAL</label>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out rounded-sm" data-index="3" data-field="travel" />
                            <label class="text-xs font-semibold text-gray-500">TRAVEL AWAY</label>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Docket Number:</label>
                            <input type="text" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="3" data-field="docket" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Supervisor Daily Initials:</label>
                            <input type="text" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="3" data-field="supervisorInitials" />
                        </div>
                    </div>
                </div>

                <!-- FRIDAY -->
                <div class="bg-white p-4 rounded-xl shadow-md border-t-4 border-blue-500 transition-all hover:shadow-xl">
                    <h3 class="text-xl font-bold text-gray-700 mb-2">Friday</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Date:</label>
                            <input type="date" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="4" data-field="date" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Shift (D/A/N):</label>
                            <select class="p-2 border border-gray-300 rounded-lg text-sm" data-index="4" data-field="shift">
                                <option value="">Select</option>
                                <option value="D">D</option>
                                <option value="A">A</option>
                                <option value="N">N</option>
                            </select>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Start Time (24h):</label>
                            <input type="time" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="4" data-field="start" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">End Time (24h):</label>
                            <input type="time" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="4" data-field="end" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Meal Break:</label>
                            <input type="time" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="4" data-field="meal" value="00:30" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Total Hours:</label>
                            <input type="text" class="p-2 border border-gray-300 bg-gray-100 rounded-lg text-sm" data-index="4" data-field="total" readonly />
                        </div>
                        <div class="flex flex-col col-span-1 md:col-span-2 lg:col-span-1">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Extra Information:</label>
                            <input type="text" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="4" data-field="extraInfo" />
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out rounded-sm" data-index="4" data-field="laha" />
                            <label class="text-xs font-semibold text-gray-500">LAHA</label>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out rounded-sm" data-index="4" data-field="lahaMeal" />
                            <label class="text-xs font-semibold text-gray-500">LAHA MEAL</label>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out rounded-sm" data-index="4" data-field="travel" />
                            <label class="text-xs font-semibold text-gray-500">TRAVEL AWAY</label>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Docket Number:</label>
                            <input type="text" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="4" data-field="docket" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Supervisor Daily Initials:</label>
                            <input type="text" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="4" data-field="supervisorInitials" />
                        </div>
                    </div>
                </div>

                <!-- SATURDAY -->
                <div class="bg-white p-4 rounded-xl shadow-md border-t-4 border-blue-500 transition-all hover:shadow-xl">
                    <h3 class="text-xl font-bold text-gray-700 mb-2">Saturday</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Date:</label>
                            <input type="date" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="5" data-field="date" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Shift (D/A/N):</label>
                            <select class="p-2 border border-gray-300 rounded-lg text-sm" data-index="5" data-field="shift">
                                <option value="">Select</option>
                                <option value="D">D</option>
                                <option value="A">A</option>
                                <option value="N">N</option>
                            </select>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Start Time (24h):</label>
                            <input type="time" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="5" data-field="start" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">End Time (24h):</label>
                            <input type="time" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="5" data-field="end" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Meal Break:</label>
                            <input type="time" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="5" data-field="meal" value="00:30" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Total Hours:</label>
                            <input type="text" class="p-2 border border-gray-300 bg-gray-100 rounded-lg text-sm" data-index="5" data-field="total" readonly />
                        </div>
                        <div class="flex flex-col col-span-1 md:col-span-2 lg:col-span-1">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Extra Information:</label>
                            <input type="text" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="5" data-field="extraInfo" />
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out rounded-sm" data-index="5" data-field="laha" />
                            <label class="text-xs font-semibold text-gray-500">LAHA</label>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out rounded-sm" data-index="5" data-field="lahaMeal" />
                            <label class="text-xs font-semibold text-gray-500">LAHA MEAL</label>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out rounded-sm" data-index="5" data-field="travel" />
                            <label class="text-xs font-semibold text-gray-500">TRAVEL AWAY</label>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Docket Number:</label>
                            <input type="text" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="5" data-field="docket" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Supervisor Daily Initials:</label>
                            <input type="text" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="5" data-field="supervisorInitials" />
                        </div>
                    </div>
                </div>

                <!-- SUNDAY -->
                <div class="bg-white p-4 rounded-xl shadow-md border-t-4 border-blue-500 transition-all hover:shadow-xl">
                    <h3 class="text-xl font-bold text-gray-700 mb-2">Sunday</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Date:</label>
                            <input type="date" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="6" data-field="date" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Shift (D/A/N):</label>
                            <select class="p-2 border border-gray-300 rounded-lg text-sm" data-index="6" data-field="shift">
                                <option value="">Select</option>
                                <option value="D">D</option>
                                <option value="A">A</option>
                                <option value="N">N</option>
                            </select>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Start Time (24h):</label>
                            <input type="time" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="6" data-field="start" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">End Time (24h):</label>
                            <input type="time" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="6" data-field="end" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Meal Break:</label>
                            <input type="time" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="6" data-field="meal" value="00:30" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Total Hours:</label>
                            <input type="text" class="p-2 border border-gray-300 bg-gray-100 rounded-lg text-sm" data-index="6" data-field="total" readonly />
                        </div>
                        <div class="flex flex-col col-span-1 md:col-span-2 lg:col-span-1">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Extra Information:</label>
                            <input type="text" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="6" data-field="extraInfo" />
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out rounded-sm" data-index="6" data-field="laha" />
                            <label class="text-xs font-semibold text-gray-500">LAHA</label>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out rounded-sm" data-index="6" data-field="lahaMeal" />
                            <label class="text-xs font-semibold text-gray-500">LAHA MEAL</label>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out rounded-sm" data-index="6" data-field="travel" />
                            <label class="text-xs font-semibold text-gray-500">TRAVEL AWAY</label>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Docket Number:</label>
                            <input type="text" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="6" data-field="docket" />
                        </div>
                        <div class="flex flex-col">
                            <label class="text-xs font-semibold text-gray-500 mb-1">Supervisor Daily Initials:</label>
                            <input type="text" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="6" data-field="supervisorInitials" />
                        </div>
                    </div>
                </div>

            </div>

            <div class="mt-8 p-6 bg-gray-50 rounded-2xl shadow-inner flex flex-col md:flex-row items-center justify-between">
                <h3 class="text-lg font-bold text-gray-700">Total Hours: <span id="totalHoursDisplay" class="text-blue-600">00:00</span></h3>
                <button id="exportPdfButton" class="mt-4 md:mt-0 px-6 py-3 bg-blue-600 text-white font-bold rounded-full shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all transform hover:scale-105">
                    Export as PDF
                </button>
            </div>

            <h2 class="text-2xl font-bold text-gray-700 mt-8 mb-4">Signatures</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="flex flex-col items-center border border-gray-300 rounded-lg p-2">
                    <h3 class="font-semibold text-gray-700">Employee Signature</h3>
                    <canvas id="employeeSignatureCanvas" class="signature-canvas" width="300" height="100"></canvas>
                    <button id="clearEmployeeSigButton" class="mt-2 px-4 py-2 bg-red-500 text-white rounded-full shadow-md hover:bg-red-600 focus:outline-none transition-colors">
                        Clear
                    </button>
                </div>
                <div class="flex flex-col items-center border border-gray-300 rounded-lg p-2">
                    <h3 class="font-semibold text-gray-700">Supervisor Signature</h3>
                    <canvas id="supervisorSignatureCanvas" class="signature-canvas" width="300" height="100"></canvas>
                    <button id="clearSupervisorSigButton" class="mt-2 px-4 py-2 bg-red-500 text-white rounded-full shadow-md hover:bg-red-600 focus:outline-none transition-colors">
                        Clear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
            apiKey: "AIzaSyCe_ZHNcao3XUWBPBv8eQgoLpJRkp63Vwg",
            authDomain: "protechtimesheet.firebaseapp.com",
            projectId: "protechtimesheet",
            storageBucket: "protechtimesheet.firebasestorage.app",
            messagingSenderId: "275584089101",
            appId: "1:275584089101:web:1b8378dc32cb92ebb5e944"
        };
        
        let timesheetData = {
            companyName: '', employeeName: '', supervisorName: '', siteName: '',
            employeePosition: '', supervisorPosition: '', weekEndDate: '', employeeId: '',
            state: '', employeeSignature: '', supervisorSignature: '',
            dailyEntries: Array(7).fill(null).map((_, i) => ({
                day: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'][i],
                date: '', shift: '', start: '', end: '', meal: '00:30', total: '00:00', extraInfo: '',
                laha: false, lahaMeal: false, travel: false, docket: '', supervisorInitials: ''
            })),
            totalHours: '00:00',
        };

        let db, auth, userId, timesheetId = null;
        let unsubscribe = null;
        const messageBox = document.getElementById('message-box');
        const shareTimesheetButton = document.getElementById('shareTimesheetButton');
        const toggleTimesheetButton = document.getElementById('toggleTimesheetButton');
        const dailyEntryInputs = document.querySelectorAll('#dailyEntriesContainer input, #dailyEntriesContainer select');
        const generalInputs = document.querySelectorAll('input:not([data-index]), select:not([data-index])');

        /**
         * Shows a non-blocking message to the user.
         * @param {string} msg - The message text.
         * @param {string} classes - Tailwind CSS classes for styling.
         */
        const showMessage = (msg, classes) => {
            messageBox.textContent = msg;
            messageBox.className = `p-4 rounded-xl text-sm font-medium border ${classes}`;
            messageBox.style.display = 'block';
        };
        
        /**
         * Hides the message box.
         */
        const hideMessage = () => {
             messageBox.style.display = 'none';
        }

        /**
         * Updates all form fields to match the timesheetData object.
         */
        const updateUI = () => {
            if (!timesheetData) return;
            
            // Update general information inputs
            document.getElementById('companyName').value = timesheetData.companyName || '';
            document.getElementById('employeeName').value = timesheetData.employeeName || '';
            document.getElementById('supervisorName').value = timesheetData.supervisorName || '';
            document.getElementById('siteName').value = timesheetData.siteName || '';
            document.getElementById('employeePosition').value = timesheetData.employeePosition || '';
            document.getElementById('supervisorPosition').value = timesheetData.supervisorPosition || '';
            document.getElementById('weekEndDate').value = timesheetData.weekEndDate || '';
            document.getElementById('employeeId').value = timesheetData.employeeId || '';
            document.getElementById('state').value = timesheetData.state || '';
            document.getElementById('totalHoursDisplay').textContent = timesheetData.totalHours || '00:00';
            document.getElementById('userIdDisplay').textContent = userId;

            // Update daily entries
            timesheetData.dailyEntries.forEach((entry, index) => {
                const row = document.querySelector(`[data-index="${index}"]`).closest('.bg-white');
                if (row) {
                    row.querySelector(`[data-field="date"]`).value = entry.date || '';
                    row.querySelector(`[data-field="shift"]`).value = entry.shift || '';
                    row.querySelector(`[data-field="start"]`).value = entry.start || '';
                    row.querySelector(`[data-field="end"]`).value = entry.end || '';
                    row.querySelector(`[data-field="meal"]`).value = entry.meal || '00:30';
                    row.querySelector(`[data-field="total"]`).value = entry.total || '00:00';
                    row.querySelector(`[data-field="extraInfo"]`).value = entry.extraInfo || '';
                    row.querySelector(`[data-field="laha"]`).checked = entry.laha;
                    row.querySelector(`[data-field="lahaMeal"]`).checked = entry.lahaMeal;
                    row.querySelector(`[data-field="travel"]`).checked = entry.travel;
                    row.querySelector(`[data-field="docket"]`).value = entry.docket || '';
                    row.querySelector(`[data-field="supervisorInitials"]`).value = entry.supervisorInitials || '';
                }
            });
            
            drawSignature('employee');
            drawSignature('supervisor');

            if (timesheetId) {
                shareTimesheetButton.style.display = 'none';
                toggleTimesheetButton.style.display = 'block';
                showMessage(`Viewing shared timesheet ID: ${timesheetId}.`, 'bg-yellow-100 text-yellow-800 border-yellow-200');
            } else {
                shareTimesheetButton.style.display = 'block';
                toggleTimesheetButton.style.display = 'none';
                hideMessage();
            }
        };

        /**
         * Saves the timesheet data to Firestore.
         * @param {object} data - The timesheet data object to save.
         */
        const saveTimesheet = async (data) => {
            if (!db || !userId) {
                showMessage('App not initialized. Please provide config.', 'bg-red-100 text-red-800 border-red-200');
                return;
            }
            const docRef = getTimesheetDocRef();
            try {
                await setDoc(docRef, data, { merge: true });
            } catch (error) {
                console.error("Error saving timesheet:", error);
                showMessage('Failed to save timesheet.', 'bg-red-100 text-red-800 border-red-200');
            }
        };

        /**
         * Calculates the total hours for each day and the grand total for the week.
         */
        const calculateTotals = () => {
            let totalMinutesAll = 0;
            timesheetData.dailyEntries.forEach(entry => {
                const start = entry.start ? entry.start.split(':').map(Number) : null;
                const end = entry.end ? entry.end.split(':').map(Number) : null;
                const meal = entry.meal ? entry.meal.split(':').map(Number) : null;

                if (start && end && meal) {
                    const startTime = start[0] * 60 + start[1];
                    const endTime = end[0] * 60 + end[1];
                    const mealTime = meal[0] * 60 + meal[1];
                    let totalMinutes = endTime - startTime - mealTime;
                    if (totalMinutes < 0) totalMinutes += 24 * 60; // Overnight shift
                    const hours = Math.floor(totalMinutes / 60);
                    const minutes = totalMinutes % 60;
                    entry.total = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                } else {
                    entry.total = '00:00';
                }
                if (entry.total) {
                    const [hours, minutes] = entry.total.split(':').map(Number);
                    totalMinutesAll += hours * 60 + minutes;
                }
            });
            const totalHours = Math.floor(totalMinutesAll / 60);
            const totalMinutes = totalMinutesAll % 60;
            timesheetData.totalHours = `${String(totalHours).padStart(2, '0')}:${String(totalMinutes).padStart(2, '0')}`;
            document.getElementById('totalHoursDisplay').textContent = timesheetData.totalHours;
        };

        /**
         * Handles input events on all form elements.
         */
        const handleInput = (event) => {
            const target = event.target;
            const index = target.dataset.index;
            const field = target.dataset.field;

            if (index !== undefined && field !== undefined) {
                const entry = timesheetData.dailyEntries[index];
                if (target.type === 'checkbox') {
                    entry[field] = target.checked;
                } else {
                    entry[field] = target.value;
                }
                calculateTotals();
            } else {
                timesheetData[target.id] = target.value;
            }
            saveTimesheet(timesheetData);
            updateUI();
        };

        /**
         * Sets up the signature canvas functionality (drawing, clearing).
         * @param {string} canvasId - The ID of the canvas element.
         * @param {string} type - 'employee' or 'supervisor' to identify the signature.
         */
        const setupSignaturePad = (canvasId, type) => {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000';

            const draw = (e) => {
                if (!isDrawing) return;
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(e.offsetX, e.offsetY);
                ctx.stroke();
                [lastX, lastY] = [e.offsetX, e.offsetY];
            };

            const handleEnd = () => {
                isDrawing = false;
                timesheetData[`${type}Signature`] = canvas.toDataURL('image/png');
                saveTimesheet(timesheetData);
            };

            canvas.addEventListener('mousedown', (e) => {
                isDrawing = true;
                [lastX, lastY] = [e.offsetX, e.offsetY];
            });
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', handleEnd);
            canvas.addEventListener('mouseout', handleEnd);

            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                isDrawing = true;
                [lastX, lastY] = [touch.clientX - rect.left, touch.clientY - rect.top];
            });
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (!isDrawing) return;
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const newX = touch.clientX - rect.left;
                const newY = touch.clientY - rect.top;
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(newX, newY);
                ctx.stroke();
                [lastX, lastY] = [newX, newY];
            });
            canvas.addEventListener('touchend', handleEnd);
            canvas.addEventListener('touchcancel', handleEnd);

            document.getElementById(`clear${type.charAt(0).toUpperCase() + type.slice(1)}SigButton`).addEventListener('click', () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                timesheetData[`${type}Signature`] = '';
                saveTimesheet(timesheetData);
            });
        };

        /**
         * Draws a saved signature data URL onto the canvas.
         * @param {string} type - 'employee' or 'supervisor'.
         */
        const drawSignature = (type) => {
            const canvas = document.getElementById(`${type}SignatureCanvas`);
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const signatureData = timesheetData[`${type}Signature`];
            if (signatureData) {
                const img = new Image();
                img.onload = () => {
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                };
                img.src = signatureData;
            }
        };

        /**
         * Exports the timesheet data as a PDF file.
         */
        const exportAsPdf = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');

            let yOffset = 10;
            const margin = 10;

            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('PROTECH WEEKLY TIMESHEET', 105, yOffset, null, null, 'center');
            doc.setFont('helvetica', 'normal');
            yOffset += 8;

            doc.setFontSize(8);
            const headerDetails = [
              { label: 'Company Name:', value: timesheetData.companyName },
              { label: 'Print Employee Name:', value: timesheetData.employeeName },
              { label: 'Print Supervisor Name:', value: timesheetData.supervisorName },
              { label: 'Site Name:', value: timesheetData.siteName },
              { label: 'Employee Position:', value: timesheetData.employeePosition },
              { label: 'Supervisor Position:', value: timesheetData.supervisorPosition },
              { label: 'WEEK END Date:', value: timesheetData.weekEndDate },
              { label: 'Emp ID:', value: timesheetData.employeeId },
              { label: 'State:', value: timesheetData.state },
            ];

            let startX = margin;
            let startY = yOffset;
            let lineGap = 6;
            headerDetails.forEach((item, index) => {
              doc.text(item.label, startX, startY + (index % 3) * lineGap);
              doc.text(item.value, startX + 40, startY + (index % 3) * lineGap);
              if (index % 3 === 2) {
                startX += 60;
              }
              if (index === 2) startX = margin + 60;
              if (index === 5) startX = margin + 120;
            });

            yOffset = startY + lineGap * 2;
            doc.text('Please note: By Signing this Timesheet above you are confirming that', margin, yOffset);
            yOffset += lineGap;
            doc.text('all the Site Safety tasks across have been completed by this employee.', margin, yOffset);
            yOffset += lineGap;
            doc.text('If this is incorrect advise your Protech Consultant immediately.', margin, yOffset);
            yOffset += lineGap * 2;

            const tableData = timesheetData.dailyEntries.map(entry => [
              entry.day,
              entry.shift,
              entry.date,
              `${entry.start} - ${entry.end}`,
              entry.meal,
              entry.total,
              entry.extraInfo,
              entry.laha ? 'Yes' : 'No',
              entry.lahaMeal ? 'Yes' : 'No',
              entry.travel ? 'Yes' : 'No',
              entry.docket,
              entry.supervisorInitials
            ]);

            doc.autoTable({
              startY: yOffset,
              head: [['Day', 'Shift', 'Date', 'Hours (24h)', 'Meal Break', 'Total', 'Extra Information', 'LAHA', 'LAHA MEAL', 'TRAVEL', 'Docket', 'Sup. Initials']],
              body: tableData,
              theme: 'grid',
              styles: { fontSize: 6, cellPadding: 1, overflow: 'linebreak' },
              headStyles: { fillColor: '#e6e6e6', textColor: '#000', fontStyle: 'bold' },
              columnStyles: {
                0: { cellWidth: 15 }, 1: { cellWidth: 15 }, 2: { cellWidth: 15 },
                3: { cellWidth: 20 }, 4: { cellWidth: 15 }, 5: { cellWidth: 15 },
                6: { cellWidth: 30 }, 7: { cellWidth: 10 }, 8: { cellWidth: 10 },
                9: { cellWidth: 10 }, 10: { cellWidth: 15 }, 11: { cellWidth: 15 },
              }
            });

            yOffset = doc.autoTable.previous.finalY + 5;
            doc.setFont('helvetica', 'bold');
            doc.text(`Total Hours: ${timesheetData.totalHours}`, 180, yOffset, null, null, 'right');
            doc.setFont('helvetica', 'normal');
            yOffset += 10;

            doc.text('Employee Signature:', margin, yOffset);
            if (timesheetData.employeeSignature) {
              const imgData = timesheetData.employeeSignature;
              doc.addImage(imgData, 'PNG', margin + 40, yOffset - 5, 50, 15);
            }
            yOffset += 20;

            doc.text('Supervisor Signature:', margin, yOffset);
            if (timesheetData.supervisorSignature) {
              const imgData = timesheetData.supervisorSignature;
              doc.addImage(imgData, 'PNG', margin + 40, yOffset - 5, 50, 15);
            }
            yOffset += 15;

            doc.setFontSize(6);
            doc.text('EMAIL SCANNED TO: mypay@protech.com.au BY MIDDAY EACH MONDAY', margin, yOffset);
            yOffset += 4;
            doc.text('Please Note: LATE TIMESHEETS MAY NOT BE PROCESSED UNTIL THE NEXT WEEK. We CANNOT ACCEPT timesheets that are not signed by your supervisor.', margin, yOffset);

            doc.save('Protech_Timesheet.pdf');
        };

        /**
         * Gets the Firestore document reference based on whether we're on a shared URL or not.
         * @returns {object} The Firestore DocumentReference object.
         */
        const getTimesheetDocRef = () => {
            if (timesheetId) {
                return doc(db, `artifacts/${appId}/public/data/timesheets/${timesheetId}`);
            }
            return doc(db, `artifacts/${appId}/users/${userId}/timesheets/draftTimesheet`);
        };

        /**
         * Sets up a real-time listener to Firestore for the timesheet data.
         */
        const setupTimesheetListener = () => {
            if (unsubscribe) {
                unsubscribe();
            }
            const docRef = getTimesheetDocRef();
            unsubscribe = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    timesheetData = docSnap.data();
                    showMessage('Data loaded from the cloud.', 'bg-blue-100 text-blue-800 border-blue-200');
                } else {
                    setDoc(docRef, timesheetData);
                    showMessage('New timesheet created.', 'bg-blue-100 text-blue-800 border-blue-200');
                }
                updateUI();
            }, (error) => {
                console.error("Error fetching timesheet:", error);
                showMessage('Failed to load timesheet data.', 'bg-red-100 text-red-800 border-red-200');
            });
        };
        
        /**
         * Parses the URL for a timesheetId query parameter.
         */
        const parseUrlForTimesheetId = () => {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('timesheetId');
        };

        /**
         * Creates a shareable public timesheet and copies the link to the clipboard.
         */
        const shareTimesheet = async () => {
            if (!timesheetData || !db) return;

            const newTimesheetId = crypto.randomUUID();
            const publicDocRef = doc(db, `artifacts/${appId}/public/data/timesheets/${newTimesheetId}`);

            try {
                await setDoc(publicDocRef, timesheetData);
                const shareableUrl = `${window.location.origin}${window.location.pathname}?timesheetId=${newTimesheetId}`;
                
                const dummyInput = document.createElement('input');
                document.body.appendChild(dummyInput);
                dummyInput.value = shareableUrl;
                dummyInput.select();
                document.execCommand('copy');
                document.body.removeChild(dummyInput);

                showMessage(`Link copied to clipboard! Share this URL with your supervisor: ${shareableUrl}`, 'bg-green-100 text-green-800 border-green-200');

                window.history.pushState({}, '', shareableUrl);
                timesheetId = newTimesheetId;
                setupTimesheetListener();

            } catch (error) {
                console.error('Error sharing timesheet:', error);
                showMessage('Failed to share timesheet.', 'bg-red-100 text-red-800 border-red-200');
            }
        };

        /**
         * Toggles back to the user's private draft timesheet.
         */
        const toggleTimesheet = () => {
            window.history.pushState({}, '', window.location.pathname);
            timesheetId = null;
            setupTimesheetListener();
        };

        /**
         * Main function to initialize the app, handle Firebase authentication, and set up listeners.
         */
        const initializeAppAndAuth = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log('Firebase user authenticated with ID:', userId);

                        timesheetId = parseUrlForTimesheetId();
                        setupTimesheetListener();
                        
                        setupSignaturePad('employeeSignatureCanvas', 'employee');
                        setupSignaturePad('supervisorSignatureCanvas', 'supervisor');

                        generalInputs.forEach(element => {
                            element.addEventListener('input', handleInput);
                            element.addEventListener('change', handleInput);
                        });

                        dailyEntryInputs.forEach(element => {
                            element.addEventListener('input', handleInput);
                            element.addEventListener('change', handleInput);
                        });
                        
                        document.getElementById('exportPdfButton').addEventListener('click', exportAsPdf);
                        document.getElementById('shareTimesheetButton').addEventListener('click', shareTimesheet);
                        document.getElementById('toggleTimesheetButton').addEventListener('click', toggleTimesheet);

                        updateUI();

                    } else {
                        // Sign in anonymously if no user is found, using the provided token if available
                        await signInWithCustomToken(auth, initialAuthToken).catch(() => signInAnonymously(auth));
                    }
                });

            } catch (error) {
                console.error("Failed to initialize the app:", error);
                showMessage(`Failed to initialize. Check your config. Error: ${error.message}`, 'bg-red-100 text-red-800 border-red-200');
            }
        };
        
        // Initial app startup
        initializeAppAndAuth();
    </script>
</body>
</html>
