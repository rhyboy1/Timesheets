<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protech Timesheet</title>
    <!-- Font and Tailwind CSS via CDN -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <!-- Firebase SDKs -->
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        input, select, button, canvas {
            border-radius: 0.75rem; /* rounded-xl */
        }
        .signature-canvas {
            border: 2px dashed #d1d5db; /* border-gray-400 */
            background-color: #f9fafb; /* bg-gray-50 */
            touch-action: none;
        }
        /* Custom spinner animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin-custom {
            animation: spin 1s linear infinite;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border-radius: 1rem;
            width: 80%;
            max-width: 500px;
            text-align: center;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 flex justify-center font-sans text-gray-800">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
        <div class="p-8 text-center text-gray-500 rounded-lg bg-white shadow-lg">
            <p class="text-xl font-semibold mb-2">Initializing Application...</p>
            <div class="w-10 h-10 border-4 border-t-4 border-blue-500 border-t-transparent rounded-full animate-spin-custom mx-auto"></div>
        </div>
    </div>
    
    <!-- Error Modal -->
    <div id="error-modal" class="modal">
        <div class="modal-content bg-red-100 border-l-4 border-red-500 text-red-700 p-4">
            <h3 class="text-xl font-bold mb-2">Application Error</h3>
            <p id="error-message">Failed to initialize the application. Please check the console for more details.</p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden bg-white p-6 md:p-10 rounded-3xl shadow-2xl w-full max-w-4xl space-y-8">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6">
            <h1 class="text-3xl md:text-4xl font-extrabold text-blue-800 tracking-tight">Protech Timesheet</h1>
            <p class="text-sm text-gray-500 mt-2 md:mt-0">User ID: <span id="userIdDisplay" class="font-mono text-gray-700"></span></p>
        </div>

        <div id="message-box" class="hidden bg-blue-100 text-blue-800 p-4 rounded-xl text-sm font-medium border border-blue-200"></div>

        <div class="flex flex-col md:flex-row gap-4 mb-6">
            <button id="toggleTimesheetButton" class="px-6 py-3 bg-gray-200 text-gray-800 font-bold rounded-full shadow-md hover:bg-gray-300 focus:outline-none focus:ring-4 focus:ring-gray-400 transition-all transform hover:scale-105">
                Back to my Timesheet
            </button>
            <button id="shareTimesheetButton" class="px-6 py-3 bg-green-500 text-white font-bold rounded-full shadow-lg hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-300 transition-all transform hover:scale-105">
                Share This Timesheet
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-gray-50 p-6 rounded-2xl shadow-inner">
            <div class="flex flex-col">
                <label class="text-sm font-semibold text-gray-600 mb-1">Company Name:</label>
                <input type="text" id="companyName" class="p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all" />
            </div>
            <div class="flex flex-col">
                <label class="text-sm font-semibold text-gray-600 mb-1">Employee Name:</label>
                <input type="text" id="employeeName" class="p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all" />
            </div>
            <div class="flex flex-col">
                <label class="text-sm font-semibold text-gray-600 mb-1">Supervisor Name:</label>
                <input type="text" id="supervisorName" class="p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all" />
            </div>
            <div class="flex flex-col">
                <label class="text-sm font-semibold text-gray-600 mb-1">Site Name:</label>
                <input type="text" id="siteName" class="p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all" />
            </div>
            <div class="flex flex-col">
                <label class="text-sm font-semibold text-gray-600 mb-1">Employee Position:</label>
                <input type="text" id="employeePosition" class="p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all" />
            </div>
            <div class="flex flex-col">
                <label class="text-sm font-semibold text-gray-600 mb-1">Supervisor Position:</label>
                <input type="text" id="supervisorPosition" class="p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all" />
            </div>
            <div class="flex flex-col">
                <label class="text-sm font-semibold text-gray-600 mb-1">Week End Date:</label>
                <input type="date" id="weekEndDate" class="p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all" />
            </div>
            <div class="flex flex-col">
                <label class="text-sm font-semibold text-gray-600 mb-1">Emp ID (from Payslip):</label>
                <input type="text" id="employeeId" class="p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all" />
            </div>
            <div class="flex flex-col">
                <label class="text-sm font-semibold text-gray-600 mb-1">State:</label>
                <input type="text" id="state" class="p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all" />
            </div>
        </div>

        <h2 class="text-2xl font-bold text-gray-700 mt-8 mb-4">Daily Entries</h2>

        <div id="dailyEntriesContainer" class="space-y-4">
            <!-- Daily entries will be generated here by JavaScript -->
        </div>

        <div class="mt-8 p-6 bg-gray-50 rounded-2xl shadow-inner flex flex-col md:flex-row items-center justify-between">
            <h3 class="text-lg font-bold text-gray-700">Total Hours: <span id="totalHoursDisplay" class="text-blue-600"></span></h3>
            <button id="exportPdfButton" class="mt-4 md:mt-0 px-6 py-3 bg-blue-600 text-white font-bold rounded-full shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all transform hover:scale-105">
                Export as PDF
            </button>
        </div>

        <h2 class="text-2xl font-bold text-gray-700 mt-8 mb-4">Signatures</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="flex flex-col items-center border border-gray-300 rounded-lg p-2">
                <h3 class="font-semibold text-gray-700">Employee Signature</h3>
                <canvas id="employeeSignatureCanvas" class="signature-canvas" width="300" height="100"></canvas>
                <button id="clearEmployeeSigButton" class="mt-2 px-4 py-2 bg-red-500 text-white rounded-full shadow-md hover:bg-red-600 focus:outline-none transition-colors">
                    Clear
                </button>
            </div>
            <div class="flex flex-col items-center border border-gray-300 rounded-lg p-2">
                <h3 class="font-semibold text-gray-700">Supervisor Signature</h3>
                <canvas id="supervisorSignatureCanvas" class="signature-canvas" width="300" height="100"></canvas>
                <button id="clearSupervisorSigButton" class="mt-2 px-4 py-2 bg-red-500 text-white rounded-full shadow-md hover:bg-red-600 focus:outline-none transition-colors">
                    Clear
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let timesheetData = {
            companyName: '', employeeName: '', supervisorName: '', siteName: '',
            employeePosition: '', supervisorPosition: '', weekEndDate: '', employeeId: '',
            state: '', employeeSignature: '', supervisorSignature: '',
            dailyEntries: [
                { day: 'Monday', date: '', shift: '', start: '', end: '', meal: '00:30', total: '', extraInfo: '', laha: false, lahaMeal: false, travel: false, docket: '', supervisorInitials: '' },
                { day: 'Tuesday', date: '', shift: '', start: '', end: '', meal: '00:30', total: '', extraInfo: '', laha: false, lahaMeal: false, travel: false, docket: '', supervisorInitials: '' },
                { day: 'Wednesday', date: '', shift: '', start: '', end: '', meal: '00:30', total: '', extraInfo: '', laha: false, lahaMeal: false, travel: false, docket: '', supervisorInitials: '' },
                { day: 'Thursday', date: '', shift: '', start: '', end: '', meal: '00:30', total: '', extraInfo: '', laha: false, lahaMeal: false, travel: false, docket: '', supervisorInitials: '' },
                { day: 'Friday', date: '', shift: '', start: '', end: '', meal: '00:30', total: '', extraInfo: '', laha: false, lahaMeal: false, travel: false, docket: '', supervisorInitials: '' },
                { day: 'Saturday', date: '', shift: '', start: '', end: '', meal: '00:30', total: '', extraInfo: '', laha: false, lahaMeal: false, travel: false, docket: '', supervisorInitials: '' },
                { day: 'Sunday', date: '', shift: '', start: '', end: '', meal: '00:30', total: '', extraInfo: '', laha: false, lahaMeal: false, travel: false, docket: '', supervisorInitials: '' },
            ],
            totalHours: '',
        };

        let db, auth, userId, timesheetId = null;
        let unsubscribe = null;
        const loadingScreen = document.getElementById('loading-screen');
        const appContainer = document.getElementById('app-container');
        const messageBox = document.getElementById('message-box');
        const errorModal = document.getElementById('error-modal');
        const shareTimesheetButton = document.getElementById('shareTimesheetButton');
        const toggleTimesheetButton = document.getElementById('toggleTimesheetButton');

        const b64toBlob = (b64Data, contentType = '', sliceSize = 512) => {
            const byteCharacters = atob(b64Data.split(',')[1]);
            const byteArrays = [];
            for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
                const slice = byteCharacters.slice(offset, offset + sliceSize);
                const byteNumbers = new Array(slice.length);
                for (let i = 0; i < slice.length; i++) {
                    byteNumbers[i] = slice.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                byteArrays.push(byteArray);
            }
            return new Blob(byteArrays, { type: contentType });
        };
        
        const showModal = (message) => {
            document.getElementById('error-message').textContent = message;
            errorModal.style.display = 'block';
        };

        const updateUI = () => {
            if (!timesheetData) return;
            document.getElementById('companyName').value = timesheetData.companyName || '';
            document.getElementById('employeeName').value = timesheetData.employeeName || '';
            document.getElementById('supervisorName').value = timesheetData.supervisorName || '';
            document.getElementById('siteName').value = timesheetData.siteName || '';
            document.getElementById('employeePosition').value = timesheetData.employeePosition || '';
            document.getElementById('supervisorPosition').value = timesheetData.supervisorPosition || '';
            document.getElementById('weekEndDate').value = timesheetData.weekEndDate || '';
            document.getElementById('employeeId').value = timesheetData.employeeId || '';
            document.getElementById('state').value = timesheetData.state || '';
            document.getElementById('totalHoursDisplay').textContent = timesheetData.totalHours || '00:00';
            document.getElementById('userIdDisplay').textContent = userId;

            const dailyEntriesContainer = document.getElementById('dailyEntriesContainer');
            dailyEntriesContainer.innerHTML = ''; // Clear existing entries

            timesheetData.dailyEntries.forEach((entry, index) => {
                const entryHtml = `
                    <div class="bg-white p-4 rounded-xl shadow-md border-t-4 border-blue-500 transition-all hover:shadow-xl">
                        <h3 class="text-xl font-bold text-gray-700 mb-2">${entry.day}</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            <div class="flex flex-col">
                                <label class="text-xs font-semibold text-gray-500 mb-1">Date:</label>
                                <input type="date" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="${index}" data-field="date" value="${entry.date || ''}" />
                            </div>
                            <div class="flex flex-col">
                                <label class="text-xs font-semibold text-gray-500 mb-1">Shift (D/A/N):</label>
                                <select class="p-2 border border-gray-300 rounded-lg text-sm" data-index="${index}" data-field="shift">
                                    <option value="">Select</option>
                                    <option value="D" ${entry.shift === 'D' ? 'selected' : ''}>D</option>
                                    <option value="A" ${entry.shift === 'A' ? 'selected' : ''}>A</option>
                                    <option value="N" ${entry.shift === 'N' ? 'selected' : ''}>N</option>
                                </select>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-xs font-semibold text-gray-500 mb-1">Start Time (24h):</label>
                                <input type="time" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="${index}" data-field="start" value="${entry.start || ''}" />
                            </div>
                            <div class="flex flex-col">
                                <label class="text-xs font-semibold text-gray-500 mb-1">End Time (24h):</label>
                                <input type="time" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="${index}" data-field="end" value="${entry.end || ''}" />
                            </div>
                            <div class="flex flex-col">
                                <label class="text-xs font-semibold text-gray-500 mb-1">Meal Break:</label>
                                <input type="time" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="${index}" data-field="meal" value="${entry.meal || '00:30'}" />
                            </div>
                            <div class="flex flex-col">
                                <label class="text-xs font-semibold text-gray-500 mb-1">Total Hours:</label>
                                <input type="text" class="p-2 border border-gray-300 bg-gray-100 rounded-lg text-sm" value="${entry.total || '00:00'}" readonly />
                            </div>
                            <div class="flex flex-col col-span-1 md:col-span-2 lg:col-span-1">
                                <label class="text-xs font-semibold text-gray-500 mb-1">Extra Information:</label>
                                <input type="text" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="${index}" data-field="extraInfo" value="${entry.extraInfo || ''}" />
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out rounded-sm" data-index="${index}" data-field="laha" ${entry.laha ? 'checked' : ''} />
                                <label class="text-xs font-semibold text-gray-500">LAHA</label>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out rounded-sm" data-index="${index}" data-field="lahaMeal" ${entry.lahaMeal ? 'checked' : ''} />
                                <label class="text-xs font-semibold text-gray-500">LAHA MEAL</label>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out rounded-sm" data-index="${index}" data-field="travel" ${entry.travel ? 'checked' : ''} />
                                <label class="text-xs font-semibold text-gray-500">TRAVEL AWAY</label>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-xs font-semibold text-gray-500 mb-1">Docket Number:</label>
                                <input type="text" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="${index}" data-field="docket" value="${entry.docket || ''}" />
                            </div>
                            <div class="flex flex-col">
                                <label class="text-xs font-semibold text-gray-500 mb-1">Supervisor Daily Initials:</label>
                                <input type="text" class="p-2 border border-gray-300 rounded-lg text-sm" data-index="${index}" data-field="supervisorInitials" value="${entry.supervisorInitials || ''}" />
                            </div>
                        </div>
                    </div>
                `;
                dailyEntriesContainer.innerHTML += entryHtml;
            });
            drawSignature('employee');
            drawSignature('supervisor');

            // Hide/show buttons based on whether it's a shared timesheet
            if (timesheetId) {
                shareTimesheetButton.style.display = 'none';
                toggleTimesheetButton.style.display = 'block';
                showMessage(`Viewing shared timesheet ID: ${timesheetId}.`, 'bg-yellow-100 text-yellow-800 border-yellow-200');
            } else {
                shareTimesheetButton.style.display = 'block';
                toggleTimesheetButton.style.display = 'none';
                showMessage('Editing your private draft timesheet.', 'bg-blue-100 text-blue-800 border-blue-200');
            }
        };

        const saveTimesheet = async (data) => {
            if (!db || !userId) return;
            const docRef = getTimesheetDocRef();
            try {
                await setDoc(docRef, data, { merge: true });
                hideMessage();
            } catch (error) {
                console.error("Error saving timesheet:", error);
                showMessage('Failed to save timesheet.', 'bg-red-100 text-red-800 border-red-200');
            }
        };

        const showMessage = (msg, classes) => {
            messageBox.textContent = msg;
            messageBox.className = `p-4 rounded-xl text-sm font-medium border ${classes}`;
            messageBox.style.display = 'block';
        };
        
        const hideMessage = () => {
             messageBox.style.display = 'none';
        }

        const calculateTotals = () => {
            let totalMinutesAll = 0;
            timesheetData.dailyEntries.forEach(entry => {
                const start = entry.start ? entry.start.split(':').map(Number) : null;
                const end = entry.end ? entry.end.split(':').map(Number) : null;
                const meal = entry.meal ? entry.meal.split(':').map(Number) : null;

                if (start && end && meal) {
                    const startTime = start[0] * 60 + start[1];
                    const endTime = end[0] * 60 + end[1];
                    const mealTime = meal[0] * 60 + meal[1];
                    let totalMinutes = endTime - startTime - mealTime;
                    if (totalMinutes < 0) totalMinutes += 24 * 60; // Overnight shift
                    const hours = Math.floor(totalMinutes / 60);
                    const minutes = totalMinutes % 60;
                    entry.total = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                } else {
                    entry.total = '';
                }
                if (entry.total) {
                    const [hours, minutes] = entry.total.split(':').map(Number);
                    totalMinutesAll += hours * 60 + minutes;
                }
            });
            const totalHours = Math.floor(totalMinutesAll / 60);
            const totalMinutes = totalMinutesAll % 60;
            timesheetData.totalHours = `${String(totalHours).padStart(2, '0')}:${String(totalMinutes).padStart(2, '0')}`;
            document.getElementById('totalHoursDisplay').textContent = timesheetData.totalHours;
        };

        const handleInput = (event) => {
            const target = event.target;
            const index = target.dataset.index;
            const field = target.dataset.field;

            if (index !== undefined && field !== undefined) {
                const entry = timesheetData.dailyEntries[index];
                if (target.type === 'checkbox') {
                    entry[field] = target.checked;
                } else {
                    entry[field] = target.value;
                }
                calculateTotals();
            } else {
                timesheetData[target.id] = target.value;
            }
            saveTimesheet(timesheetData);
            updateUI();
        };

        const setupSignaturePad = (canvasId, type) => {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000';

            const draw = (e) => {
                if (!isDrawing) return;
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(e.offsetX, e.offsetY);
                ctx.stroke();
                [lastX, lastY] = [e.offsetX, e.offsetY];
            };

            const handleEnd = () => {
                isDrawing = false;
                timesheetData[`${type}Signature`] = canvas.toDataURL('image/png');
                saveTimesheet(timesheetData);
            };

            canvas.addEventListener('mousedown', (e) => {
                isDrawing = true;
                [lastX, lastY] = [e.offsetX, e.offsetY];
            });
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', handleEnd);
            canvas.addEventListener('mouseout', handleEnd);

            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                isDrawing = true;
                [lastX, lastY] = [touch.clientX - rect.left, touch.clientY - rect.top];
            });
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (!isDrawing) return;
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const newX = touch.clientX - rect.left;
                const newY = touch.clientY - rect.top;
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(newX, newY);
                ctx.stroke();
                [lastX, lastY] = [newX, newY];
            });
            canvas.addEventListener('touchend', handleEnd);
            canvas.addEventListener('touchcancel', handleEnd);

            document.getElementById(`clear${type.charAt(0).toUpperCase() + type.slice(1)}SigButton`).addEventListener('click', () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                timesheetData[`${type}Signature`] = '';
                saveTimesheet(timesheetData);
            });
        };

        const drawSignature = (type) => {
            const canvas = document.getElementById(`${type}SignatureCanvas`);
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const signatureData = timesheetData[`${type}Signature`];
            if (signatureData) {
                const img = new Image();
                img.onload = () => {
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                };
                img.src = signatureData;
            }
        };

        const exportAsPdf = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');

            let yOffset = 10;
            const margin = 10;

            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('PROTECH WEEKLY TIMESHEET', 105, yOffset, null, null, 'center');
            doc.setFont('helvetica', 'normal');
            yOffset += 8;

            doc.setFontSize(8);
            const headerDetails = [
              { label: 'Company Name:', value: timesheetData.companyName },
              { label: 'Print Employee Name:', value: timesheetData.employeeName },
              { label: 'Print Supervisor Name:', value: timesheetData.supervisorName },
              { label: 'Site Name:', value: timesheetData.siteName },
              { label: 'Employee Position:', value: timesheetData.employeePosition },
              { label: 'Supervisor Position:', value: timesheetData.supervisorPosition },
              { label: 'WEEK END Date:', value: timesheetData.weekEndDate },
              { label: 'Emp ID:', value: timesheetData.employeeId },
              { label: 'State:', value: timesheetData.state },
            ];

            let startX = margin;
            let startY = yOffset;
            let lineGap = 6;
            headerDetails.forEach((item, index) => {
              if (index % 3 === 0 && index !== 0) {
                startY += lineGap * 2;
                startX = margin;
              }
              doc.text(item.label, startX, startY);
              doc.text(item.value, startX + 40, startY);
              startX += 60;
              if (index % 3 === 2) {
                startY += lineGap;
              }
            });

            yOffset = startY + lineGap * 2;
            doc.text('Please note: By Signing this Timesheet above you are confirming that', margin, yOffset);
            yOffset += lineGap;
            doc.text('all the Site Safety tasks across have been completed by this employee.', margin, yOffset);
            yOffset += lineGap;
            doc.text('If this is incorrect advise your Protech Consultant immediately.', margin, yOffset);
            yOffset += lineGap * 2;

            const tableData = timesheetData.dailyEntries.map(entry => [
              entry.day,
              entry.shift,
              entry.date,
              `${entry.start} - ${entry.end}`,
              entry.meal,
              entry.total,
              entry.extraInfo,
              entry.laha ? 'Yes' : 'No',
              entry.lahaMeal ? 'Yes' : 'No',
              entry.travel ? 'Yes' : 'No',
              entry.docket,
              entry.supervisorInitials
            ]);

            doc.autoTable({
              startY: yOffset,
              head: [['Day', 'Shift', 'Date', 'Hours (24h)', 'Meal Break', 'Total', 'Extra Information', 'LAHA', 'LAHA MEAL', 'TRAVEL', 'Docket', 'Sup. Initials']],
              body: tableData,
              theme: 'grid',
              styles: { fontSize: 6, cellPadding: 1, overflow: 'linebreak' },
              headStyles: { fillColor: '#e6e6e6', textColor: '#000', fontStyle: 'bold' },
              columnStyles: {
                0: { cellWidth: 15 }, 1: { cellWidth: 15 }, 2: { cellWidth: 15 },
                3: { cellWidth: 20 }, 4: { cellWidth: 15 }, 5: { cellWidth: 15 },
                6: { cellWidth: 30 }, 7: { cellWidth: 10 }, 8: { cellWidth: 10 },
                9: { cellWidth: 10 }, 10: { cellWidth: 15 }, 11: { cellWidth: 15 },
              }
            });

            yOffset = doc.autoTable.previous.finalY + 5;
            doc.setFont('helvetica', 'bold');
            doc.text(`Total Hours: ${timesheetData.totalHours}`, 180, yOffset, null, null, 'right');
            doc.setFont('helvetica', 'normal');
            yOffset += 10;

            doc.text('Employee Signature:', margin, yOffset);
            if (timesheetData.employeeSignature) {
              const imgData = timesheetData.employeeSignature;
              doc.addImage(imgData, 'PNG', margin + 40, yOffset - 5, 50, 15);
            }
            yOffset += 20;

            doc.text('Supervisor Signature:', margin, yOffset);
            if (timesheetData.supervisorSignature) {
              const imgData = timesheetData.supervisorSignature;
              doc.addImage(imgData, 'PNG', margin + 40, yOffset - 5, 50, 15);
            }
            yOffset += 15;

            doc.setFontSize(6);
            doc.text('EMAIL SCANNED TO: mypay@protech.com.au BY MIDDAY EACH MONDAY', margin, yOffset);
            yOffset += 4;
            doc.text('Please Note: LATE TIMESHEETS MAY NOT BE PROCESSED UNTIL THE NEXT WEEK. We CANNOT ACCEPT timesheets that are not signed by your supervisor.', margin, yOffset);

            doc.save('Protech_Timesheet.pdf');
        };

        const getTimesheetDocRef = () => {
            if (timesheetId) {
                return doc(db, `artifacts/${appId}/public/data/timesheets/${timesheetId}`);
            }
            return doc(db, `artifacts/${appId}/users/${userId}/timesheets/draftTimesheet`);
        };

        const setupTimesheetListener = () => {
            if (unsubscribe) {
                unsubscribe();
            }
            const docRef = getTimesheetDocRef();
            unsubscribe = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    timesheetData = docSnap.data();
                    showMessage('Data loaded from the cloud.', 'bg-blue-100 text-blue-800 border-blue-200');
                } else {
                    // Create a default timesheet if one doesn't exist
                    setDoc(docRef, timesheetData);
                    showMessage('New timesheet created.', 'bg-blue-100 text-blue-800 border-blue-200');
                }
                updateUI();
            }, (error) => {
                console.error("Error fetching timesheet:", error);
                showMessage('Failed to load timesheet data.', 'bg-red-100 text-red-800 border-red-200');
            });
        };
        
        const parseUrlForTimesheetId = () => {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('timesheetId');
        };

        const shareTimesheet = async () => {
            if (!timesheetData || !db) return;

            const newTimesheetId = crypto.randomUUID();
            const publicDocRef = doc(db, `artifacts/${appId}/public/data/timesheets/${newTimesheetId}`);

            try {
                await setDoc(publicDocRef, timesheetData);
                const shareableUrl = `${window.location.origin}${window.location.pathname}?timesheetId=${newTimesheetId}`;
                
                // Copy the URL to clipboard
                const dummyInput = document.createElement('input');
                document.body.appendChild(dummyInput);
                dummyInput.value = shareableUrl;
                dummyInput.select();
                document.execCommand('copy');
                document.body.removeChild(dummyInput);

                showMessage(`Link copied to clipboard! Share this URL with your supervisor: ${shareableUrl}`, 'bg-green-100 text-green-800 border-green-200');

                // Redirect to the new shared timesheet
                window.history.pushState({}, '', shareableUrl);
                timesheetId = newTimesheetId;
                setupTimesheetListener();

            } catch (error) {
                console.error('Error sharing timesheet:', error);
                showMessage('Failed to share timesheet.', 'bg-red-100 text-red-800 border-red-200');
            }
        };

        const toggleTimesheet = () => {
            window.history.pushState({}, '', window.location.pathname);
            timesheetId = null;
            setupTimesheetListener();
        };

        const initializeAppAndAuth = async () => {
            try {
                // Ensure the Firebase config is available before proceeding
                if (!firebaseConfig || !firebaseConfig.projectId) {
                    throw new Error("Firebase configuration is missing or invalid.");
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                userId = auth.currentUser.uid;
                console.log('Firebase user authenticated with ID:', userId);

                timesheetId = parseUrlForTimesheetId();
                setupTimesheetListener();

                // Hide loading and show app
                loadingScreen.style.display = 'none';
                appContainer.style.display = 'block';

                // Signature pads setup
                setupSignaturePad('employeeSignatureCanvas', 'employee');
                setupSignaturePad('supervisorSignatureCanvas', 'supervisor');

                // Event listeners for top-level fields
                document.querySelectorAll('input:not([data-index]), select:not([data-index])').forEach(element => {
                    element.addEventListener('input', handleInput);
                    element.addEventListener('change', handleInput);
                });

                // Event delegation for dynamically created daily entry fields
                document.getElementById('dailyEntriesContainer').addEventListener('input', handleInput);
                document.getElementById('dailyEntriesContainer').addEventListener('change', handleInput);

                document.getElementById('exportPdfButton').addEventListener('click', exportAsPdf);
                document.getElementById('shareTimesheetButton').addEventListener('click', shareTimesheet);
                document.getElementById('toggleTimesheetButton').addEventListener('click', toggleTimesheet);

            } catch (error) {
                console.error("Failed to initialize the app:", error);
                loadingScreen.style.display = 'none';
                showModal(`Failed to initialize the app. Details: ${error.message}`);
            }
        };

        document.addEventListener('DOMContentLoaded', initializeAppAndAuth);
    </script>
</body>
</html>
