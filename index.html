<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protech Timesheet</title>
    <!-- Font and Tailwind CSS via CDN -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <!-- Firebase SDKs -->
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .timesheet-container {
            max-width: 1024px;
            margin: auto;
        }
        input[type="text"], input[type="date"], input[type="number"], input[type="time"], textarea, select {
            border-color: #d1d5db;
        }
        /* Custom styles for time inputs */
        input[type="time"]::-webkit-calendar-picker-indicator {
            display: none;
        }
        input[type="time"]::-webkit-inner-spin-button, 
        input[type="time"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .checkbox-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
        }
        .signature-pad {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background-color: #fff;
            cursor: crosshair;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Main App Container -->
    <div class="timesheet-container bg-white shadow-xl rounded-2xl p-6 sm:p-10 border border-gray-200">
        <div id="auth-info" class="text-xs text-gray-500 mb-4 flex items-center">
            <svg class="w-4 h-4 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
            <span>Authenticated as: <span id="user-id">Loading...</span></span>
        </div>

        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-2">Protech Timesheet</h1>
        <p class="text-gray-500 mb-8 text-lg">Manage and export your weekly work hours.</p>

        <!-- Employee and Site Information Section -->
        <div class="bg-gray-50 rounded-xl p-6 mb-8 border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Employee & Site Details</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <input type="text" id="company-name" class="w-full rounded-lg px-4 py-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="Company Name">
                <input type="text" id="employee-name" class="w-full rounded-lg px-4 py-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="Employee Name">
                <input type="text" id="supervisor-name" class="w-full rounded-lg px-4 py-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="Supervisor Name">
                <input type="text" id="site-name" class="w-full rounded-lg px-4 py-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="Site Name">
                <input type="text" id="employee-position" class="w-full rounded-lg px-4 py-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="Employee Position">
                <input type="text" id="supervisor-position" class="w-full rounded-lg px-4 py-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="Supervisor Position">
                <input type="date" id="we-date" class="w-full rounded-lg px-4 py-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="WE Date">
                <input type="text" id="emp-id" class="w-full rounded-lg px-4 py-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="Employee ID">
                <input type="text" id="state" class="w-full rounded-lg px-4 py-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150" placeholder="State">
            </div>
        </div>

        <!-- Weekly Timesheet Table -->
        <div class="overflow-x-auto bg-white rounded-xl shadow-inner border border-gray-200 mb-8">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Day</th>
                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Shift</th>
                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start</th>
                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Finish</th>
                        <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Lunch<br>(30 min)</th>
                        <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                        <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">LAHA</th>
                        <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">LAHA MEAL</th>
                        <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">TRAVEL<br>AWAY</th>
                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Docket<br>Number</th>
                        <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supervisor<br>Initials</th>
                        <th class="px-2 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="timesheet-body" class="bg-white divide-y divide-gray-200">
                    <!-- Timesheet entries for each day will be rendered here -->
                </tbody>
                <tfoot class="bg-gray-50">
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900" colspan="6">Total Hours</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900" id="total-hours" colspan="6">0</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Signature Pads Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-8">
            <!-- Employee Signature Pad -->
            <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
                <h3 class="text-xl font-bold text-gray-800 mb-2">Employee Signature</h3>
                <p class="text-sm text-gray-500 mb-4">Click and drag to sign.</p>
                <canvas id="employee-signature-pad" class="signature-pad w-full h-32"></canvas>
                <button onclick="clearSignature('employee')" class="mt-2 text-sm text-red-600 hover:text-red-800 transition duration-150">Clear Signature</button>
            </div>
            
            <!-- Supervisor Signature Pad -->
            <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
                <h3 class="text-xl font-bold text-gray-800 mb-2">Supervisor Signature</h3>
                <p class="text-sm text-gray-500 mb-4">Click and drag to sign.</p>
                <canvas id="supervisor-signature-pad" class="signature-pad w-full h-32"></canvas>
                <button onclick="clearSignature('supervisor')" class="mt-2 text-sm text-red-600 hover:text-red-800 transition duration-150">Clear Signature</button>
            </div>
        </div>

        <!-- PDF Generation and Messages -->
        <div class="mt-8 flex flex-col sm:flex-row justify-between items-center gap-4">
            <button onclick="generatePDF()" class="w-full sm:w-auto flex-1 bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition duration-150 ease-in-out transform hover:scale-105">Generate Timesheet PDF</button>
            <div id="message-box" class="w-full sm:w-auto flex-1 p-3 text-sm text-center rounded-lg font-medium opacity-0 transition-opacity duration-300"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firebase configuration and app ID are provided by the environment
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;
        const messageBox = document.getElementById('message-box');
        let timesheetDocRef;

        // Timesheet data structure, now including signature data URLs
        let timesheetData = {
            header: {
                companyName: '',
                employeeName: '',
                supervisorName: '',
                siteName: '',
                employeePosition: '',
                supervisorPosition: '',
                weDate: '',
                empId: '',
                state: '',
                employeeSignature: '',
                supervisorSignature: ''
            },
            entries: [
                { day: 'Monday', date: '', shift: '', startTime: '', finishTime: '', total: 0, lunchChecked: false, lahaChecked: false, lahaMealChecked: false, travelChecked: false, docketNumber: '', supervisorInitials: '' },
                { day: 'Tuesday', date: '', shift: '', startTime: '', finishTime: '', total: 0, lunchChecked: false, lahaChecked: false, lahaMealChecked: false, travelChecked: false, docketNumber: '', supervisorInitials: '' },
                { day: 'Wednesday', date: '', shift: '', startTime: '', finishTime: '', total: 0, lunchChecked: false, lahaChecked: false, lahaMealChecked: false, travelChecked: false, docketNumber: '', supervisorInitials: '' },
                { day: 'Thursday', date: '', shift: '', startTime: '', finishTime: '', total: 0, lunchChecked: false, lahaChecked: false, lahaMealChecked: false, travelChecked: false, docketNumber: '', supervisorInitials: '' },
                { day: 'Friday', date: '', shift: '', startTime: '', finishTime: '', total: 0, lunchChecked: false, lahaChecked: false, lahaMealChecked: false, travelChecked: false, docketNumber: '', supervisorInitials: '' },
                { day: 'Saturday', date: '', shift: '', startTime: '', finishTime: '', total: 0, lunchChecked: false, lahaChecked: false, lahaMealChecked: false, travelChecked: false, docketNumber: '', supervisorInitials: '' },
                { day: 'Sunday', date: '', shift: '', startTime: '', finishTime: '', total: 0, lunchChecked: false, lahaChecked: false, lahaMealChecked: false, travelChecked: false, docketNumber: '', supervisorInitials: '' }
            ]
        };

        // Signature pad variables
        const employeeSignaturePad = document.getElementById('employee-signature-pad');
        const supervisorSignaturePad = document.getElementById('supervisor-signature-pad');
        let isDrawing = false;
        let activePad = null;
        let authReady = false;

        // Utility function to show messages
        function showMessage(message, styleClass) {
            messageBox.textContent = message;
            messageBox.className = `w-full sm:w-auto flex-1 p-3 text-sm text-center rounded-lg font-medium opacity-100 transition-opacity duration-300 ${styleClass}`;
            setTimeout(() => {
                messageBox.className = `w-full sm:w-auto flex-1 p-3 text-sm text-center rounded-lg font-medium opacity-0 transition-opacity duration-300`;
            }, 5000);
        }

        // Initialize Firebase and Auth
        async function initializeAppAndAuth() {
            if (Object.keys(firebaseConfig).length === 0) {
                showMessage("Firebase config is missing. Cannot initialize.", 'bg-red-100 text-red-800 border-red-200');
                console.error("Firebase config is missing. Cannot initialize.");
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Start the authentication process and listen for state changes
                onAuthStateChanged(auth, (user) => {
                    authReady = true;
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id').textContent = userId;
                        showMessage("Successfully authenticated.", 'bg-green-100 text-green-800 border-green-200');
                        startFirestoreListener();
                        setupSignaturePads();
                    } else {
                        // Handle the sign-in
                        if (initialAuthToken) {
                            signInWithCustomToken(auth, initialAuthToken).catch(error => {
                                console.error("Error signing in with custom token:", error);
                                showMessage(`Auth error: ${error.message}`, 'bg-red-100 text-red-800 border-red-200');
                            });
                        } else {
                            signInAnonymously(auth).catch(error => {
                                console.error("Error signing in anonymously:", error);
                                showMessage(`Auth error: ${error.message}`, 'bg-red-100 text-red-800 border-red-200');
                            });
                        }
                    }
                });
            } catch (error) {
                console.error("Failed to initialize the app:", error);
                showMessage(`Failed to initialize. Error: ${error.message}`, 'bg-red-100 text-red-800 border-red-200');
            }
        }

        // Start Firestore listener for real-time updates
        function startFirestoreListener() {
            if (!userId) {
                console.error("User ID is missing, cannot start Firestore listener.");
                return;
            }
            if (!appId) {
                console.error("App ID is missing, cannot create timesheet document reference.");
                return;
            }

            timesheetDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'timesheets', userId);

            onSnapshot(timesheetDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    timesheetData = docSnap.data();
                } else {
                    saveDataToFirestore(); // Create initial document
                }
                renderTimesheet();
                loadHeaderData();
                loadSignatures();
            }, (error) => {
                console.error("Error fetching timesheet data:", error);
                showMessage(`Error fetching data: ${error.message}`, 'bg-red-100 text-red-800 border-red-200');
            });
        }
        
        // Loads header data from Firestore into the form
        function loadHeaderData() {
            document.getElementById('company-name').value = timesheetData.header.companyName || '';
            document.getElementById('employee-name').value = timesheetData.header.employeeName || '';
            document.getElementById('supervisor-name').value = timesheetData.header.supervisorName || '';
            document.getElementById('site-name').value = timesheetData.header.siteName || '';
            document.getElementById('employee-position').value = timesheetData.header.employeePosition || '';
            document.getElementById('supervisor-position').value = timesheetData.header.supervisorPosition || '';
            document.getElementById('we-date').value = timesheetData.header.weDate || '';
            document.getElementById('emp-id').value = timesheetData.header.empId || '';
            document.getElementById('state').value = timesheetData.header.state || '';

            // Attach listeners to update timesheetData.header on input change
            const headerFields = ['company-name', 'employee-name', 'supervisor-name', 'site-name', 'employee-position', 'supervisor-position', 'we-date', 'emp-id', 'state'];
            headerFields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    element.oninput = () => {
                        timesheetData.header[field.replace(/-/g, '')] = element.value;
                        if (authReady) saveDataToFirestore();
                    };
                }
            });
        }

        // Renders the timesheet table based on the timesheetData array
        function renderTimesheet() {
            const timesheetBody = document.getElementById('timesheet-body');
            timesheetBody.innerHTML = '';
            
            let totalHours = 0;

            timesheetData.entries.forEach((entry, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-100 transition-colors duration-150';
                
                const shiftOptions = `
                    <option value="">N/A</option>
                    <option value="D" ${entry.shift === 'D' ? 'selected' : ''}>D</option>
                    <option value="A" ${entry.shift === 'A' ? 'selected' : ''}>A</option>
                    <option value="N" ${entry.shift === 'N' ? 'selected' : ''}>N</option>
                `;

                row.innerHTML = `
                    <td class="px-2 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${entry.day}</td>
                    <td class="px-2 py-4 whitespace-nowrap"><input type="date" value="${entry.date}" onchange="updateEntry(${index}, 'date', this.value)" class="w-full rounded-lg px-2 py-1 text-sm"></td>
                    <td class="px-2 py-4 whitespace-nowrap">
                        <select onchange="updateEntry(${index}, 'shift', this.value)" class="w-full rounded-lg px-2 py-1 text-sm">
                            ${shiftOptions}
                        </select>
                    </td>
                    <td class="px-2 py-4 whitespace-nowrap"><input type="time" value="${entry.startTime}" onchange="updateEntry(${index}, 'startTime', this.value)" class="w-full rounded-lg px-2 py-1 text-sm"></td>
                    <td class="px-2 py-4 whitespace-nowrap"><input type="time" value="${entry.finishTime}" onchange="updateEntry(${index}, 'finishTime', this.value)" class="w-full rounded-lg px-2 py-1 text-sm"></td>
                    <td class="px-2 py-4 whitespace-nowrap"><div class="checkbox-container"><input type="checkbox" ${entry.lunchChecked ? 'checked' : ''} onchange="updateEntry(${index}, 'lunchChecked', this.checked)" class="w-5 h-5 rounded text-blue-600 focus:ring-blue-500"></div></td>
                    <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-500" id="total-hours-${index}">${calculateDailyTotal(entry)}</td>
                    <td class="px-2 py-4 whitespace-nowrap"><div class="checkbox-container"><input type="checkbox" ${entry.lahaChecked ? 'checked' : ''} onchange="updateEntry(${index}, 'lahaChecked', this.checked)" class="w-5 h-5 rounded text-blue-600 focus:ring-blue-500"></div></td>
                    <td class="px-2 py-4 whitespace-nowrap"><div class="checkbox-container"><input type="checkbox" ${entry.lahaMealChecked ? 'checked' : ''} onchange="updateEntry(${index}, 'lahaMealChecked', this.checked)" class="w-5 h-5 rounded text-blue-600 focus:ring-blue-500"></div></td>
                    <td class="px-2 py-4 whitespace-nowrap"><div class="checkbox-container"><input type="checkbox" ${entry.travelChecked ? 'checked' : ''} onchange="updateEntry(${index}, 'travelChecked', this.checked)" class="w-5 h-5 rounded text-blue-600 focus:ring-blue-500"></div></td>
                    <td class="px-2 py-4 whitespace-nowrap"><input type="text" value="${entry.docketNumber}" onchange="updateEntry(${index}, 'docketNumber', this.value)" class="w-full rounded-lg px-2 py-1 text-sm"></td>
                    <td class="px-2 py-4 whitespace-nowrap"><input type="text" value="${entry.supervisorInitials}" onchange="updateEntry(${index}, 'supervisorInitials', this.value)" class="w-full rounded-lg px-2 py-1 text-sm"></td>
                    <td class="px-2 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="clearEntry(${index})" class="text-red-600 hover:text-red-900 transition-colors duration-150">Clear</button>
                    </td>
                `;
                timesheetBody.appendChild(row);
                totalHours += parseFloat(calculateDailyTotal(entry)) || 0;
            });
            document.getElementById('total-hours').textContent = totalHours.toFixed(2);
        }

        // Calculate daily total hours
        function calculateDailyTotal(entry) {
            if (!entry.startTime || !entry.finishTime) {
                return '0.00';
            }
            
            const start = new Date(`1970/01/01 ${entry.startTime}`);
            const finish = new Date(`1970/01/01 ${entry.finishTime}`);
            
            let diff = (finish - start) / (1000 * 60); // Difference in minutes

            if (diff < 0) {
                diff += 24 * 60; // Handle overnight shifts
            }

            // Deduct 30 minutes if lunch is checked
            if (entry.lunchChecked) {
                diff -= 30;
            }

            const total = diff / 60;
            return total >= 0 ? total.toFixed(2) : '0.00';
        }

        // Update a specific entry field and save to Firestore
        window.updateEntry = function(index, field, value) {
            timesheetData.entries[index][field] = value;
            timesheetData.entries[index].total = calculateDailyTotal(timesheetData.entries[index]);
            document.getElementById(`total-hours-${index}`).textContent = timesheetData.entries[index].total;
            
            let totalHours = timesheetData.entries.reduce((sum, entry) => sum + parseFloat(calculateDailyTotal(entry)), 0);
            document.getElementById('total-hours').textContent = totalHours.toFixed(2);
            if (authReady) saveDataToFirestore();
        }

        // Clear a daily entry
        window.clearEntry = function(index) {
            timesheetData.entries[index] = { 
                day: timesheetData.entries[index].day, 
                date: '', 
                shift: '', 
                startTime: '', 
                finishTime: '', 
                total: 0,
                lunchChecked: false,
                lahaChecked: false,
                lahaMealChecked: false,
                travelChecked: false,
                docketNumber: '',
                supervisorInitials: ''
            };
            renderTimesheet();
            if (authReady) saveDataToFirestore();
        }

        // Saves the current timesheet data to Firestore
        async function saveDataToFirestore() {
            if (!userId || !timesheetDocRef) {
                showMessage("Authentication or document reference error. Cannot save data.", 'bg-red-100 text-red-800 border-red-200');
                return;
            }

            try {
                await setDoc(timesheetDocRef, timesheetData);
                showMessage("Timesheet saved successfully!", 'bg-green-100 text-green-800 border-green-200');
            } catch (error) {
                console.error("Error saving document: ", error);
                showMessage(`Error saving: ${error.message}`, 'bg-red-100 text-red-800 border-red-200');
            }
        }
        
        // Signature pad functions
        function setupSignaturePads() {
            [employeeSignaturePad, supervisorSignaturePad].forEach(canvas => {
                if (!canvas) return; // Add a check to ensure the canvas element exists
                const ctx = canvas.getContext('2d');
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                ctx.lineWidth = 2;
                ctx.strokeStyle = '#000000';
                ctx.lineCap = 'round';
            });
            
            employeeSignaturePad.addEventListener('mousedown', (e) => startDrawing(e, 'employee'));
            employeeSignaturePad.addEventListener('mousemove', draw);
            employeeSignaturePad.addEventListener('mouseup', endDrawing);
            employeeSignaturePad.addEventListener('mouseout', endDrawing);

            supervisorSignaturePad.addEventListener('mousedown', (e) => startDrawing(e, 'supervisor'));
            supervisorSignaturePad.addEventListener('mousemove', draw);
            supervisorSignaturePad.addEventListener('mouseup', endDrawing);
            supervisorSignaturePad.addEventListener('mouseout', endDrawing);
        }

        function startDrawing(e, padType) {
            isDrawing = true;
            activePad = padType === 'employee' ? employeeSignaturePad : supervisorSignaturePad;
            const ctx = activePad.getContext('2d');
            const rect = activePad.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function draw(e) {
            if (!isDrawing) return;
            const ctx = activePad.getContext('2d');
            const rect = activePad.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            ctx.lineTo(x, y);
            ctx.stroke();
        }

        function endDrawing() {
            if (!isDrawing) return;
            isDrawing = false;
            activePad.getContext('2d').closePath();
            
            // Save the signature to timesheetData
            if (activePad.id === 'employee-signature-pad') {
                timesheetData.header.employeeSignature = employeeSignaturePad.toDataURL();
            } else {
                timesheetData.header.supervisorSignature = supervisorSignaturePad.toDataURL();
            }
            if (authReady) saveDataToFirestore();
        }

        window.clearSignature = function(padType) {
            const canvas = padType === 'employee' ? employeeSignaturePad : supervisorSignaturePad;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (padType === 'employee') {
                timesheetData.header.employeeSignature = '';
            } else {
                timesheetData.header.supervisorSignature = '';
            }
            if (authReady) saveDataToFirestore();
        }
        
        function loadSignatures() {
            if (timesheetData.header.employeeSignature) {
                const img = new Image();
                img.onload = () => {
                    const ctx = employeeSignaturePad.getContext('2d');
                    ctx.clearRect(0, 0, employeeSignaturePad.width, employeeSignaturePad.height);
                    ctx.drawImage(img, 0, 0, employeeSignaturePad.width, employeeSignaturePad.height);
                };
                img.src = timesheetData.header.employeeSignature;
            } else {
                const ctx = employeeSignaturePad.getContext('2d');
                ctx.clearRect(0, 0, employeeSignaturePad.width, employeeSignaturePad.height);
            }
            
            if (timesheetData.header.supervisorSignature) {
                const img = new Image();
                img.onload = () => {
                    const ctx = supervisorSignaturePad.getContext('2d');
                    ctx.clearRect(0, 0, supervisorSignaturePad.width, supervisorSignaturePad.height);
                    ctx.drawImage(img, 0, 0, supervisorSignaturePad.width, supervisorSignaturePad.height);
                };
                img.src = timesheetData.header.supervisorSignature;
            } else {
                const ctx = supervisorSignaturePad.getContext('2d');
                ctx.clearRect(0, 0, supervisorSignaturePad.width, supervisorSignaturePad.height);
            }
        }

        // Generates and downloads a PDF that mimics the uploaded timesheet
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // --- PDF Layout from Provided Document ---
            doc.setFont('helvetica', 'normal');
            
            // Header Section
            doc.setFontSize(10);
            doc.text("Company Name:", 14, 20);
            doc.text(timesheetData.header.companyName, 50, 20);
            doc.text("Print Employee Name:", 14, 25);
            doc.text(timesheetData.header.employeeName, 50, 25);
            doc.text("Print Supervisor Name:", 14, 30);
            doc.text(timesheetData.header.supervisorName, 50, 30);
            doc.text("Site Name:", 14, 35);
            doc.text(timesheetData.header.siteName, 50, 35);
            doc.text("Employee Position:", 14, 40);
            doc.text(timesheetData.header.employeePosition, 50, 40);
            doc.text("Supervisor Position:", 14, 45);
            doc.text(timesheetData.header.supervisorPosition, 50, 45);

            doc.text("WE Date:", 110, 25);
            doc.text(timesheetData.header.weDate, 135, 25);
            doc.text("Emp ID:", 110, 30);
            doc.text(timesheetData.header.empId, 135, 30);
            doc.text("State:", 110, 35);
            doc.text(timesheetData.header.state, 135, 35);
            
            // Timesheet title
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text("PROTECH WEEKLY TIMESHEET", 100, 15, null, null, 'center');
            doc.setFont('helvetica', 'normal');
            
            // Timesheet Table
            const bodyData = timesheetData.entries.map(entry => {
                const lahaText = entry.lahaChecked ? "Yes" : "No";
                const lahaMealText = entry.lahaMealChecked ? "Yes" : "No";
                const travelText = entry.travelChecked ? "Yes" : "No";
                
                return [
                    entry.day,
                    entry.date,
                    entry.shift,
                    entry.startTime,
                    entry.finishTime,
                    entry.lunchChecked ? '00:30' : '', // Mimic the original PDF
                    entry.total,
                    '', // Extra Information column, left blank for now
                    lahaText,
                    lahaMealText,
                    travelText,
                    entry.docketNumber,
                    entry.supervisorInitials
                ];
            });

            doc.autoTable({
                startY: 55,
                head: [
                    ['Day', 'Date', 'Shift\n(D) (A) or (N)', 'Start', 'Finish', 'Meal Break', 'Total', 'Extra Information', 'LAHA', 'LAHA MEAL', 'TRAVEL AWAY', 'Docket Number', 'Supervisor Daily Initials']
                ],
                body: bodyData,
                styles: { fontSize: 7, cellPadding: 1, overflow: 'linebreak' },
                headStyles: { fillColor: '#e5e7eb', textColor: '#1f2937', halign: 'center', valign: 'middle' },
                bodyStyles: { textColor: '#4b5563' },
                alternateRowStyles: { fillColor: '#f9fafb' },
                columnStyles: {
                    0: { cellWidth: 15 }, // Day
                    1: { cellWidth: 15 }, // Date
                    2: { cellWidth: 15 }, // Shift
                    3: { cellWidth: 15 }, // Start
                    4: { cellWidth: 15 }, // Finish
                    5: { cellWidth: 15 }, // Meal
                    6: { cellWidth: 15 }, // Total
                    7: { cellWidth: 20 }, // Extra Info
                    8: { cellWidth: 10 }, // LAHA
                    9: { cellWidth: 10 }, // LAHA MEAL
                    10: { cellWidth: 10 }, // TRAVEL AWAY
                    11: { cellWidth: 15 }, // Docket
                    12: { cellWidth: 20 },// Supervisor Initials
                },
                didParseCell: function(data) {
                    if (data.section === 'head') {
                        data.cell.styles.halign = 'center';
                        data.cell.styles.valign = 'middle';
                    }
                }
            });
            
            const totalHours = timesheetData.entries.reduce((sum, entry) => sum + parseFloat(entry.total), 0);
            doc.text(`Total Hours: ${totalHours.toFixed(2)}`, 14, doc.autoTable.previous.finalY + 10);
            
            // Signatures
            const signatureY = doc.autoTable.previous.finalY + 20;
            doc.text("Employee Signature:", 14, signatureY);
            if (timesheetData.header.employeeSignature) {
                doc.addImage(timesheetData.header.employeeSignature, 'PNG', 50, signatureY - 10, 50, 20);
            }
            
            doc.text("Supervisor Signature:", 110, signatureY);
            if (timesheetData.header.supervisorSignature) {
                doc.addImage(timesheetData.header.supervisorSignature, 'PNG', 150, signatureY - 10, 50, 20);
            }
            
            doc.save('protech_timesheet.pdf');
        }

        // Initial render and start the application
        renderTimesheet();
        initializeAppAndAuth();
    </script>
</body>
</html>
